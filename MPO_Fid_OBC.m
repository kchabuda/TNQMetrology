function [result,c] = MPO_Fid_OBC(figureofmerit,n,d,bdl,lherm,imprecision,A,B,phi,c)
% Parameters
tol1 = phi;
tol2 = phi;
relunc1 = 0.1*imprecision;
relunc2 = imprecision;
global ncon_skipCheckInputs;
ncon_skipCheckInputs = true;
% Functions
function y = pinv2(x,tol)
    [uf,sf,vf] = svd(x);
    sf = diag(sf);
    positionf = sf > sf(1)*tol;
    sf2 = sf(positionf).^-1;
    sf2(end+1:numel(sf)) = 0;
    sf2 = diag(sf2);
    y = vf*sf2*uf';
end   
% Calculations
%  MPO
%  2Tr(r'L)-Tr(rLL) maximization
if figureofmerit == 1
    L1F = cell([1,n-1]);
    L1_0F = cell([1,n-1]);
    L2F = cell([1,n-1]);
    fom1 = zeros([n*100,1]);
    index = 0;
    iter1 = 0;
    while 1
        iter1 = iter1+1;
        tensors = {c(:,1,:,:,n),B{n}};
        legs = {[-1,-3,1,2],[-2,-4,2,1]};
        L1F{n-1} = ncon(tensors,legs);
        tensors = {c(:,1,:,:,n),A{n}};
        legs = {[-1,-3,1,2],[-2,-4,2,1]};
        L1_0F{n-1} = ncon(tensors,legs);
        tensors = {c(:,1,:,:,n),A{n},c(:,1,:,:,n)};
        legs = {[-1,-4,1,2],[-2,-5,2,3],[-3,-6,3,1]};
        L2F{n-1} = ncon(tensors,legs);
        for x = n-1:-1:2
            tensors = {c(:,:,:,:,x),B{x},L1F{x}};
            legs = {[-1,3,1,2],[-2,4,2,1],[3,4]};
            L1F{x-1} = ncon(tensors,legs);
            tensors = {c(:,:,:,:,x),A{x},L1_0F{x}};
            legs = {[-1,3,1,2],[-2,4,2,1],[3,4]};
            L1_0F{x-1} = ncon(tensors,legs);
            tensors = {c(:,:,:,:,x),A{x},c(:,:,:,:,x),L2F{x}};
            legs = {[-1,4,1,2],[-2,5,2,3],[-3,6,3,1],[4,5,6]};
            L2F{x-1} = ncon(tensors,legs);
        end
        tensors = {B{1},L1F{1}};
        legs = {[-5,1,-4,-3],[-2,1,-1]};
        l1 = ncon(tensors,legs);
        l1 = reshape(l1,[bdl*d*d,1]);
        tensors = {A{1},L1_0F{1}};
        legs = {[-5,1,-4,-3],[-2,1,-1]};
        l1_0 = ncon(tensors,legs);
        l1_0 = reshape(l1_0,[bdl*d*d,1]);
        tensors = {A{1},eye(d),L2F{1}};
        legs = {[-9,1,-4,-7],[-8,-3],[-2,1,-6,-1,-5]};
        l2 = ncon(tensors,legs);
        l2 = reshape(l2,[bdl*d*d,bdl*d*d]);
        dl2 = l2+l2.';
        dl1 = 2*(l1-l1_0)/phi;
        dl2pinv = pinv2(dl2,tol1);
        dl2pinv = (dl2pinv+dl2pinv.')/2;
        cv = dl2pinv*dl1;
        c(1,:,:,:,1) = reshape(cv,[1,bdl,d,d]);
        if lherm == 1
            c(:,:,:,:,1) = (c(:,:,:,:,1)+conj(permute(c(:,:,:,:,1),[1,2,4,3])))/2;
            cv = reshape(c(1,:,:,:,1),[bdl*d*d,1]);
        end
        index = index+1;
        fom1(index) = real(2*cv.'*(l1-l1_0)/phi-cv.'*l2*cv);
        tensors = {c(1,:,:,:,1),B{1}};
        legs = {[-3,-1,1,2],[-4,-2,2,1]};
        l1c = ncon(tensors,legs);
        tensors = {c(1,:,:,:,1),A{1}};
        legs = {[-3,-1,1,2],[-4,-2,2,1]};
        l1_0c = ncon(tensors,legs);
        tensors = {c(1,:,:,:,1),A{1},c(1,:,:,:,1)};
        legs = {[-4,-1,1,2],[-5,-2,2,3],[-6,-3,3,1]};
        l2c = ncon(tensors,legs);
        for x = 2:n-1
            tensors = {l1c,B{x},L1F{x}};
            legs = {[-1,1],[1,2,-4,-3],[-2,2]};
            l1 = ncon(tensors,legs);
            l1 = reshape(l1,[bdl*bdl*d*d,1]);
            tensors = {l1_0c,A{x},L1_0F{x}};
            legs = {[-1,1],[1,2,-4,-3],[-2,2]};
            l1_0 = ncon(tensors,legs);
            l1_0 = reshape(l1_0,[bdl*bdl*d*d,1]);
            tensors = {l2c,A{x},eye(d),L2F{x}};
            legs = {[-1,1,-5],[1,2,-4,-7],[-8,-3],[-2,2,-6]};
            l2 = ncon(tensors,legs);
            l2 = reshape(l2,[bdl*bdl*d*d,bdl*bdl*d*d]);
            dl2 = l2+l2.';
            dl1 = 2*(l1-l1_0)/phi;
            dl2pinv = pinv2(dl2,tol1);
            dl2pinv = (dl2pinv+dl2pinv.')/2;
            cv = dl2pinv*dl1;
            c(:,:,:,:,x) = reshape(cv,[bdl,bdl,d,d]);
            if lherm == 1
                c(:,:,:,:,x) = (c(:,:,:,:,x)+conj(permute(c(:,:,:,:,x),[1,2,4,3])))/2;
                cv = reshape(c(:,:,:,:,x),[bdl*bdl*d*d,1]);
            end
            index = index+1;
            fom1(index) = real(2*cv.'*(l1-l1_0)/phi-cv.'*l2*cv);
            tensors = {l1c,c(:,:,:,:,x),B{x}};
            legs = {[3,4],[3,-1,1,2],[4,-2,2,1]};
            l1c = ncon(tensors,legs);
            tensors = {l1_0c,c(:,:,:,:,x),A{x}};
            legs = {[3,4],[3,-1,1,2],[4,-2,2,1]};
            l1_0c = ncon(tensors,legs);
            tensors = {l2c,c(:,:,:,:,x),A{x},c(:,:,:,:,x)};
            legs = {[4,5,6],[4,-1,1,2],[5,-2,2,3],[6,-3,3,1]};
            l2c = ncon(tensors,legs);
        end
        tensors = {l1c,B{n}};
        legs = {[-1,1,-2],[1,-5,-4,-3]};
        l1 = ncon(tensors,legs);
        l1 = reshape(l1,[bdl*d*d,1]);
        tensors = {l1_0c,A{n}};
        legs = {[-1,1,-2],[1,-5,-4,-3]};
        l1_0 = ncon(tensors,legs);
        l1_0 = reshape(l1_0,[bdl*d*d,1]);
        tensors = {l2c,A{n},eye(d)};
        legs = {[-1,1,-5,-2,-6,],[1,-9,-4,-7],[-8,-3]};
        l2 = ncon(tensors,legs);
        l2 = reshape(l2,[bdl*d*d,bdl*d*d]);
        dl2 = l2+l2.';
        dl1 = 2*(l1-l1_0)/phi;
        dl2pinv = pinv2(dl2,tol1);
        dl2pinv = (dl2pinv+dl2pinv.')/2;
        cv = dl2pinv*dl1;
        c(:,1,:,:,n) = reshape(cv,[bdl,1,d,d]);
        if lherm == 1
            c(:,:,:,:,n) = (c(:,:,:,:,n)+conj(permute(c(:,:,:,:,n),[1,2,4,3])))/2;
            cv = reshape(c(:,1,:,:,n),[bdl*d*d,1]);
        end
        index = index+1;
        fom1(index) = real(2*cv.'*(l1-l1_0)/phi-cv.'*l2*cv);
        if iter1 >= 2 && all(fom1((iter1-2)*n+1:iter1*n) > 0) && std(fom1((iter1-2)*n+1:iter1*n),1)/mean(fom1((iter1-2)*n+1:iter1*n)) <= relunc1
            break
        end
    end
    fom1 = fom1(1:index);
    %plot(fom1)
    f = fom1(index);
%  ||2*r'-rL-Lr||^2/||2*r'||^2 minimization
elseif figureofmerit == 2
    tensors = {B{n},B{n}};
    legs = {[-1,-3,1,2],[-2,-4,2,1]};
    l0_1 = ncon(tensors,legs);
    for x = n-1:-1:2
        tensors = {B{x},B{x},l0_1};
        legs = {[-1,3,1,2],[-2,4,2,1],[3,4]};
        l0_1 = ncon(tensors,legs);
    end
    tensors = {B{1},B{1},l0_1};
    legs = {[-1,3,1,2],[-2,4,2,1],[3,4]};
    l0_1 = ncon(tensors,legs);
    tensors = {B{n},A{n}};
    legs = {[-1,-3,1,2],[-2,-4,2,1]};
    l0_2 = ncon(tensors,legs);
    for x = n-1:-1:2
        tensors = {B{x},A{x},l0_2};
        legs = {[-1,3,1,2],[-2,4,2,1],[3,4]};
        l0_2 = ncon(tensors,legs);
    end
    tensors = {B{1},A{1},l0_2};
    legs = {[-1,3,1,2],[-2,4,2,1],[3,4]};
    l0_2 = ncon(tensors,legs);
    tensors = {A{n},A{n}};
    legs = {[-1,-3,1,2],[-2,-4,2,1]};
    l0_3 = ncon(tensors,legs);
    for x = n-1:-1:2
        tensors = {A{x},A{x},l0_3};
        legs = {[-1,3,1,2],[-2,4,2,1],[3,4]};
        l0_3 = ncon(tensors,legs);
    end
    tensors = {A{1},A{1},l0_3};
    legs = {[-1,3,1,2],[-2,4,2,1],[3,4]};
    l0_3 = ncon(tensors,legs);
    l0 = (l0_1-2*l0_2+l0_3)/phi^2;
    l0 = abs(l0);
    if lherm == 1
        L1_0F = cell([1,n-1]);
        L1_1F = cell([1,n-1]);
        L1_2F = cell([1,n-1]);
        L2_1F = cell([1,n-1]);
        L2_2F = cell([1,n-1]);
        fom2 = zeros([n*100,1]);
        index = 0;
        iter2 = 0;
        while 1
            iter2 = iter2+1;
            tensors = {c(:,1,:,:,n),A{n},A{n}};
            legs = {[-1,-4,1,2],[-2,-5,2,3],[-3,-6,3,1]};
            L1_0F{n-1} = ncon(tensors,legs);
            tensors = {c(:,1,:,:,n),B{n},A{n}};
            legs = {[-1,-4,1,2],[-2,-5,2,3],[-3,-6,3,1]};
            L1_1F{n-1} = ncon(tensors,legs);
            tensors = {c(:,1,:,:,n),A{n},B{n}};
            legs = {[-1,-4,1,2],[-2,-5,2,3],[-3,-6,3,1]};
            L1_2F{n-1} = ncon(tensors,legs);
            tensors = {conj(c(:,1,:,:,n)),A{n},c(:,1,:,:,n),A{n}};
            legs = {[-1,-5,2,1],[-2,-6,2,3],[-3,-7,3,4],[-4,-8,4,1]};
            L2_1F{n-1} = ncon(tensors,legs);
            tensors = {c(:,1,:,:,n),c(:,1,:,:,n),A{n},A{n}};
            legs = {[-1,-5,1,2],[-2,-6,2,3],[-3,-7,3,4],[-4,-8,4,1]};
            L2_2F{n-1} = ncon(tensors,legs);
            for x = n-1:-1:2
                tensors = {c(:,:,:,:,x),A{x},A{x},L1_0F{x}};
                legs = {[-1,4,1,2],[-2,5,2,3],[-3,6,3,1],[4,5,6]};
                L1_0F{x-1} = ncon(tensors,legs);
                tensors = {c(:,:,:,:,x),B{x},A{x},L1_1F{x}};
                legs = {[-1,4,1,2],[-2,5,2,3],[-3,6,3,1],[4,5,6]};
                L1_1F{x-1} = ncon(tensors,legs);
                tensors = {c(:,:,:,:,x),A{x},B{x},L1_2F{x}};
                legs = {[-1,4,1,2],[-2,5,2,3],[-3,6,3,1],[4,5,6]};
                L1_2F{x-1} = ncon(tensors,legs);
                tensors = {conj(c(:,:,:,:,x)),A{x},c(:,:,:,:,x),A{x},L2_1F{x}};
                legs = {[-1,5,2,1],[-2,6,2,3],[-3,7,3,4],[-4,8,4,1],[5,6,7,8]};
                L2_1F{x-1} = ncon(tensors,legs);
                tensors = {c(:,:,:,:,x),c(:,:,:,:,x),A{x},A{x},L2_2F{x}};
                legs = {[-1,5,1,2],[-2,6,2,3],[-3,7,3,4],[-4,8,4,1],[5,6,7,8]};
                L2_2F{x-1} = ncon(tensors,legs);
            end
            tensors = {A{1},A{1},L1_0F{1}};
            legs = {[-5,2,-4,1],[-6,3,1,-3],[-2,2,3,-1]};
            l1_0 = ncon(tensors,legs);
            l1_0 = reshape(l1_0,[bdl*d*d,1]);
            tensors = {B{1},A{1},L1_1F{1}};
            legs = {[-5,2,-4,1],[-6,3,1,-3],[-2,2,3,-1]};
            l1_1 = ncon(tensors,legs);
            l1_1 = reshape(l1_1,[bdl*d*d,1]);
            tensors = {A{1},B{1},L1_2F{1}};
            legs = {[-5,2,-4,1],[-6,3,1,-3],[-2,2,3,-1]};
            l1_2 = ncon(tensors,legs);
            l1_2 = reshape(l1_2,[bdl*d*d,1]);
            tensors = {A{1},A{1},L2_1F{1}};
            legs = {[-9,1,-4,-7],[-10,2,-8,-3],[-2,1,-6,2,-1,-5]};
            l2_1 = ncon(tensors,legs);
            l2_1 = reshape(l2_1,[bdl*d*d,bdl*d*d]);
            tensors = {eye(d),A{1},A{1},L2_2F{1}};
            legs = {[-4,-7],[-9,2,-8,1],[-10,3,1,-3],[-2,-6,2,3,-1,-5]};
            l2_2 = ncon(tensors,legs);
            l2_2 = reshape(l2_2,[bdl*d*d,bdl*d*d]);
            dl2 = l2_1+l2_1.'+l2_2+l2_2.';
            dl1 = 2*(l1_1+l1_2-2*l1_0)/phi;
            dl2pinv = pinv2(dl2,tol2);
            dl2pinv = (dl2pinv+dl2pinv.')/2;
            cv = dl2pinv*dl1;
            c(1,:,:,:,1) = reshape(cv,[1,bdl,d,d]);
            c(:,:,:,:,1) = (c(:,:,:,:,1)+conj(permute(c(:,:,:,:,1),[1,2,4,3])))/2;
            cv = reshape(c(1,:,:,:,1),[bdl*d*d,1]);
            index = index+1;
            fom2(index) = abs(1+(-4*(cv.'*l1_1+cv.'*l1_2-2*cv.'*l1_0)/phi+2*(cv.'*l2_1*cv+cv.'*l2_2*cv))/(4*l0));
            tensors = {c(1,:,:,:,1),A{1},A{1}};
            legs = {[-4,-1,1,2],[-5,-2,2,3],[-6,-3,3,1]};
            l1_0c = ncon(tensors,legs);
            tensors = {c(1,:,:,:,1),B{1},A{1}};
            legs = {[-4,-1,1,2],[-5,-2,2,3],[-6,-3,3,1]};
            l1_1c = ncon(tensors,legs);
            tensors = {c(1,:,:,:,1),A{1},B{1}};
            legs = {[-4,-1,1,2],[-5,-2,2,3],[-6,-3,3,1]};
            l1_2c = ncon(tensors,legs);
            tensors = {c(1,:,:,:,1),A{1},c(1,:,:,:,1),A{1}};
            legs = {[-5,-1,1,2],[-6,-2,2,3],[-7,-3,3,4],[-8,-4,4,1]};
            l2_1c = ncon(tensors,legs);
            tensors = {c(1,:,:,:,1),c(1,:,:,:,1),A{1},A{1}};
            legs = {[-5,-1,1,2],[-6,-2,2,3],[-7,-3,3,4],[-8,-4,4,1]};
            l2_2c = ncon(tensors,legs);
            for x = 2:n-1
                tensors = {l1_0c,A{x},A{x},L1_0F{x}};
                legs = {[-1,2,3],[2,4,-4,1],[3,5,1,-3],[-2,4,5]};
                l1_0 = ncon(tensors,legs);
                l1_0 = reshape(l1_0,[bdl*bdl*d*d,1]);
                tensors = {l1_1c,B{x},A{x},L1_1F{x}};
                legs = {[-1,2,3],[2,4,-4,1],[3,5,1,-3],[-2,4,5]};
                l1_1 = ncon(tensors,legs);
                l1_1 = reshape(l1_1,[bdl*bdl*d*d,1]);
                tensors = {l1_2c,A{x},B{x},L1_2F{x}};
                legs = {[-1,2,3],[2,4,-4,1],[3,5,1,-3],[-2,4,5]};
                l1_2 = ncon(tensors,legs);
                l1_2 = reshape(l1_2,[bdl*bdl*d*d,1]);
                tensors = {l2_1c,A{x},A{x},L2_1F{x}};
                legs = {[-1,1,-5,2],[1,3,-4,-7],[2,4,-8,-3],[-2,3,-6,4]};
                l2_1 = ncon(tensors,legs);
                l2_1 = reshape(l2_1,[bdl*bdl*d*d,bdl*bdl*d*d]);
                tensors = {l2_2c,eye(d),A{x},A{x},L2_2F{x}};
                legs = {[-1,-5,2,3],[-4,-7],[2,4,-8,1],[3,5,1,-3],[-2,-6,4,5]};
                l2_2 = ncon(tensors,legs);
                l2_2 = reshape(l2_2,[bdl*bdl*d*d,bdl*bdl*d*d]);
                dl2 = l2_1+l2_1.'+l2_2+l2_2.';
                dl1 = 2*(l1_1+l1_2-2*l1_0)/phi;
                dl2pinv = pinv2(dl2,tol2);
                dl2pinv = (dl2pinv+dl2pinv.')/2;
                cv = dl2pinv*dl1;
                c(:,:,:,:,x) = reshape(cv,[bdl,bdl,d,d]);
                c(:,:,:,:,x) = (c(:,:,:,:,x)+conj(permute(c(:,:,:,:,x),[1,2,4,3])))/2;
                cv = reshape(c(:,:,:,:,x),[bdl*bdl*d*d,1]);
                index = index+1;
                fom2(index) = abs(1+(-4*(cv.'*l1_1+cv.'*l1_2-2*cv.'*l1_0)/phi+2*(cv.'*l2_1*cv+cv.'*l2_2*cv))/(4*l0));
                tensors = {l1_0c,c(:,:,:,:,x),A{x},A{x}};
                legs = {[4,5,6],[4,-1,1,2],[5,-2,2,3],[6,-3,3,1]};
                l1_0c = ncon(tensors,legs);
                tensors = {l1_1c,c(:,:,:,:,x),B{x},A{x}};
                legs = {[4,5,6],[4,-1,1,2],[5,-2,2,3],[6,-3,3,1]};
                l1_1c = ncon(tensors,legs);
                tensors = {l1_2c,c(:,:,:,:,x),A{x},B{x}};
                legs = {[4,5,6],[4,-1,1,2],[5,-2,2,3],[6,-3,3,1]};
                l1_2c = ncon(tensors,legs);
                tensors = {l2_1c,c(:,:,:,:,x),A{x},c(:,:,:,:,x),A{x}};
                legs = {[5,6,7,8],[5,-1,1,2],[6,-2,2,3],[7,-3,3,4],[8,-4,4,1]};
                l2_1c = ncon(tensors,legs);
                tensors = {l2_2c,c(:,:,:,:,x),c(:,:,:,:,x),A{x},A{x}};
                legs = {[5,6,7,8],[5,-1,1,2],[6,-2,2,3],[7,-3,3,4],[8,-4,4,1]};
                l2_2c = ncon(tensors,legs);
            end
            tensors = {l1_0c,A{n},A{n}};
            legs = {[-1,2,3,-2],[2,-5,-4,1],[3,-6,1,-3]};
            l1_0 = ncon(tensors,legs);
            l1_0 = reshape(l1_0,[bdl*d*d,1]);
            tensors = {l1_1c,B{n},A{n}};
            legs = {[-1,2,3,-2],[2,-5,-4,1],[3,-6,1,-3]};
            l1_1 = ncon(tensors,legs);
            l1_1 = reshape(l1_1,[bdl*d*d,1]);
            tensors = {l1_2c,A{n},B{n}};
            legs = {[-1,2,3,-2],[2,-5,-4,1],[3,-6,1,-3]};
            l1_2 = ncon(tensors,legs);
            l1_2 = reshape(l1_2,[bdl*d*d,1]);
            tensors = {l2_1c,A{n},A{n}};
            legs = {[-1,1,-5,2,-2,-6],[1,-9,-4,-7],[2,-10,-8,-3]};
            l2_1 = ncon(tensors,legs);
            l2_1 = reshape(l2_1,[bdl*d*d,bdl*d*d]);
            tensors = {l2_2c,eye(d),A{n},A{n}};
            legs = {[-1,-5,2,3,-2,-6],[-4,-7],[2,-9,-8,1],[3,-10,1,-3]};
            l2_2 = ncon(tensors,legs);
            l2_2 = reshape(l2_2,[bdl*d*d,bdl*d*d]);
            dl2 = l2_1+l2_1.'+l2_2+l2_2.';
            dl1 = 2*(l1_1+l1_2-2*l1_0)/phi;
            dl2pinv = pinv2(dl2,tol2);
            dl2pinv = (dl2pinv+dl2pinv.')/2;
            cv = dl2pinv*dl1;
            c(:,1,:,:,n) = reshape(cv,[bdl,1,d,d]);
            c(:,:,:,:,n) = (c(:,:,:,:,n)+conj(permute(c(:,:,:,:,n),[1,2,4,3])))/2;
            cv = reshape(c(:,1,:,:,n),[bdl*d*d,1]);
            index = index+1;
            fom2(index) = abs(1+(-4*(cv.'*l1_1+cv.'*l1_2-2*cv.'*l1_0)/phi+2*(cv.'*l2_1*cv+cv.'*l2_2*cv))/(4*l0));
            if fom2(index) < 10^-10 || iter2 >= 20 || (iter2 >= 2 && std(fom2((iter2-2)*n+1:iter2*n),1)/mean(fom2((iter2-2)*n+1:iter2*n)) <= relunc2)
                break
            end
        end
    else
        L1_0AF = cell([1,n-1]);
        L1_1F = cell([1,n-1]);
        L1_2F = cell([1,n-1]);
        L1_0BF = cell([1,n-1]);
        L1_3F = cell([1,n-1]);
        L1_4F = cell([1,n-1]);
        L2_1F = cell([1,n-1]);
        L2_2F = cell([1,n-1]);
        L2_3F = cell([1,n-1]);
        fom2 = zeros([n*100,1]);
        index = 0;
        iter2 = 0;
        while 1
            iter2 = iter2+1;
            tensors = {conj(c(:,1,:,:,n)),A{n},A{n}};
            legs = {[-1,-4,2,1],[-2,-5,2,3],[-3,-6,3,1]};
            L1_0AF{n-1} = ncon(tensors,legs);
            tensors = {conj(c(:,1,:,:,n)),B{n},A{n}};
            legs = {[-1,-4,2,1],[-2,-5,2,3],[-3,-6,3,1]};
            L1_1F{n-1} = ncon(tensors,legs);
            tensors = {conj(c(:,1,:,:,n)),A{n},B{n}};
            legs = {[-1,-4,2,1],[-2,-5,2,3],[-3,-6,3,1]};
            L1_2F{n-1} = ncon(tensors,legs);
            tensors = {c(:,1,:,:,n),A{n},A{n}};
            legs = {[-1,-4,1,2],[-2,-5,2,3],[-3,-6,3,1]};
            L1_0BF{n-1} = ncon(tensors,legs);
            tensors = {c(:,1,:,:,n),B{n},A{n}};
            legs = {[-1,-4,1,2],[-2,-5,2,3],[-3,-6,3,1]};
            L1_3F{n-1} = ncon(tensors,legs);
            tensors = {c(:,1,:,:,n),A{n},B{n}};
            legs = {[-1,-4,1,2],[-2,-5,2,3],[-3,-6,3,1]};
            L1_4F{n-1} = ncon(tensors,legs);
            tensors = {conj(c(:,1,:,:,n)),A{n},c(:,1,:,:,n),A{n}};
            legs = {[-1,-5,2,1],[-2,-6,2,3],[-3,-7,3,4],[-4,-8,4,1]};
            L2_1F{n-1} = ncon(tensors,legs);
            tensors = {conj(c(:,1,:,:,n)),A{n},A{n},c(:,1,:,:,n)};
            legs = {[-1,-5,2,1],[-2,-6,2,3],[-3,-7,3,4],[-4,-8,4,1]};
            L2_2F{n-1} = ncon(tensors,legs);
            tensors = {conj(c(:,1,:,:,n)),c(:,1,:,:,n),A{n},A{n}};
            legs = {[-1,-5,2,1],[-2,-6,2,3],[-3,-7,3,4],[-4,-8,4,1]};
            L2_3F{n-1} = ncon(tensors,legs);
            for x = n-1:-1:2
                tensors = {conj(c(:,:,:,:,x)),A{x},A{x},L1_0AF{x}};
                legs = {[-1,4,2,1],[-2,5,2,3],[-3,6,3,1],[4,5,6]};
                L1_0AF{x-1} = ncon(tensors,legs);
                tensors = {conj(c(:,:,:,:,x)),B{x},A{x},L1_1F{x}};
                legs = {[-1,4,2,1],[-2,5,2,3],[-3,6,3,1],[4,5,6]};
                L1_1F{x-1} = ncon(tensors,legs);
                tensors = {conj(c(:,:,:,:,x)),A{x},B{x},L1_2F{x}};
                legs = {[-1,4,2,1],[-2,5,2,3],[-3,6,3,1],[4,5,6]};
                L1_2F{x-1} = ncon(tensors,legs);
                tensors = {c(:,:,:,:,x),A{x},A{x},L1_0BF{x}};
                legs = {[-1,4,1,2],[-2,5,2,3],[-3,6,3,1],[4,5,6]};
                L1_0BF{x-1} = ncon(tensors,legs);
                tensors = {c(:,:,:,:,x),B{x},A{x},L1_3F{x}};
                legs = {[-1,4,1,2],[-2,5,2,3],[-3,6,3,1],[4,5,6]};
                L1_3F{x-1} = ncon(tensors,legs);
                tensors = {c(:,:,:,:,x),A{x},B{x},L1_4F{x}};
                legs = {[-1,4,1,2],[-2,5,2,3],[-3,6,3,1],[4,5,6]};
                L1_4F{x-1} = ncon(tensors,legs);
                tensors = {conj(c(:,:,:,:,x)),A{x},c(:,:,:,:,x),A{x},L2_1F{x}};
                legs = {[-1,5,2,1],[-2,6,2,3],[-3,7,3,4],[-4,8,4,1],[5,6,7,8]};
                L2_1F{x-1} = ncon(tensors,legs);
                tensors = {conj(c(:,:,:,:,x)),A{x},A{x},c(:,:,:,:,x),L2_2F{x}};
                legs = {[-1,5,2,1],[-2,6,2,3],[-3,7,3,4],[-4,8,4,1],[5,6,7,8]};
                L2_2F{x-1} = ncon(tensors,legs);
                tensors = {conj(c(:,:,:,:,x)),c(:,:,:,:,x),A{x},A{x},L2_3F{x}};
                legs = {[-1,5,2,1],[-2,6,2,3],[-3,7,3,4],[-4,8,4,1],[5,6,7,8]};
                L2_3F{x-1} = ncon(tensors,legs);
            end
            tensors = {A{1},A{1},L1_0AF{1}};
            legs = {[-5,2,-3,1],[-6,3,1,-4],[-2,2,3,-1]};
            l1_0a = ncon(tensors,legs);
            l1_0a = reshape(l1_0a,[bdl*d*d,1]);
            tensors = {B{1},A{1},L1_1F{1}};
            legs = {[-5,2,-3,1],[-6,3,1,-4],[-2,2,3,-1]};
            l1_1 = ncon(tensors,legs);
            l1_1 = reshape(l1_1,[bdl*d*d,1]);
            tensors = {A{1},B{1},L1_2F{1}};
            legs = {[-5,2,-3,1],[-6,3,1,-4],[-2,2,3,-1]};
            l1_2 = ncon(tensors,legs);
            l1_2 = reshape(l1_2,[bdl*d*d,1]);
            tensors = {A{1},A{1},L1_0BF{1}};
            legs = {[-5,2,-4,1],[-6,3,1,-3],[-2,2,3,-1]};
            l1_0b = ncon(tensors,legs);
            l1_0b = reshape(l1_0b,[bdl*d*d,1]);
            tensors = {B{1},A{1},L1_3F{1}};
            legs = {[-5,2,-4,1],[-6,3,1,-3],[-2,2,3,-1]};
            l1_3 = ncon(tensors,legs);
            l1_3 = reshape(l1_3,[bdl*d*d,1]);
            tensors = {A{1},B{1},L1_4F{1}};
            legs = {[-5,2,-4,1],[-6,3,1,-3],[-2,2,3,-1]};
            l1_4 = ncon(tensors,legs);
            l1_4 = reshape(l1_4,[bdl*d*d,1]);
            tensors = {A{1},A{1},L2_1F{1}};
            legs = {[-9,1,-3,-7],[-10,2,-8,-4],[-2,1,-6,2,-1,-5]};
            l2_1 = ncon(tensors,legs);
            l2_1 = reshape(l2_1,[bdl*d*d,bdl*d*d]);
            tensors = {A{1},A{1},eye(d),L2_2F{1}};
            legs = {[-9,2,-3,1],[-10,3,1,-7],[-8,-4],[-2,2,3,-6,-1,-5]};
            l2_2 = ncon(tensors,legs);
            l2_2 = reshape(l2_2,[bdl*d*d,bdl*d*d]);
            tensors = {eye(d),A{1},A{1},L2_3F{1}};
            legs = {[-3,-7],[-9,2,-8,1],[-10,3,1,-4],[-2,-6,2,3,-1,-5]};
            l2_3 = ncon(tensors,legs);
            l2_3 = reshape(l2_3,[bdl*d*d,bdl*d*d]);
            dl2 = 2*l2_1+l2_2+l2_3;
            dl2 = (dl2+dl2')/2;
            dl1 = 2*(l1_1+l1_2-2*l1_0a)/phi;
            dl2pinv = pinv2(dl2,tol2);
            dl2pinv = (dl2pinv+dl2pinv')/2;
            cv = dl2pinv*dl1;
            c(1,:,:,:,1) = reshape(cv,[1,bdl,d,d]);
            index = index+1;
            fom2(index) = abs(1+(-2*(cv'*l1_1+cv'*l1_2-2*cv'*l1_0a+cv.'*l1_3+cv.'*l1_4-2*cv.'*l1_0b)/phi+2*cv'*l2_1*cv+cv'*l2_2*cv+cv'*l2_3*cv)/(4*l0));
            tensors = {conj(c(1,:,:,:,1)),A{1},A{1}};
            legs = {[-4,-1,2,1],[-5,-2,2,3],[-6,-3,3,1]};
            l1_0ac = ncon(tensors,legs);
            tensors = {conj(c(1,:,:,:,1)),B{1},A{1}};
            legs = {[-4,-1,2,1],[-5,-2,2,3],[-6,-3,3,1]};
            l1_1c = ncon(tensors,legs);
            tensors = {conj(c(1,:,:,:,1)),A{1},B{1}};
            legs = {[-4,-1,2,1],[-5,-2,2,3],[-6,-3,3,1]};
            l1_2c = ncon(tensors,legs);
            tensors = {c(1,:,:,:,1),A{1},A{1}};
            legs = {[-4,-1,1,2],[-5,-2,2,3],[-6,-3,3,1]};
            l1_0bc = ncon(tensors,legs);
            tensors = {c(1,:,:,:,1),B{1},A{1}};
            legs = {[-4,-1,1,2],[-5,-2,2,3],[-6,-3,3,1]};
            l1_3c = ncon(tensors,legs);
            tensors = {c(1,:,:,:,1),A{1},B{1}};
            legs = {[-4,-1,1,2],[-5,-2,2,3],[-6,-3,3,1]};
            l1_4c = ncon(tensors,legs);
            tensors = {conj(c(1,:,:,:,1)),A{1},c(1,:,:,:,1),A{1}};
            legs = {[-5,-1,2,1],[-6,-2,2,3],[-7,-3,3,4],[-8,-4,4,1]};
            l2_1c = ncon(tensors,legs);
            tensors = {conj(c(1,:,:,:,1)),A{1},A{1},c(1,:,:,:,1)};
            legs = {[-5,-1,2,1],[-6,-2,2,3],[-7,-3,3,4],[-8,-4,4,1]};
            l2_2c = ncon(tensors,legs);
            tensors = {conj(c(1,:,:,:,1)),c(1,:,:,:,1),A{1},A{1}};
            legs = {[-5,-1,2,1],[-6,-2,2,3],[-7,-3,3,4],[-8,-4,4,1]};
            l2_3c = ncon(tensors,legs);
            for x = 2:n-1
                tensors = {l1_0ac,A{x},A{x},L1_0AF{x}};
                legs = {[-1,2,3],[2,4,-3,1],[3,5,1,-4],[-2,4,5]};
                l1_0a = ncon(tensors,legs);
                l1_0a = reshape(l1_0a,[bdl*bdl*d*d,1]);
                tensors = {l1_1c,B{x},A{x},L1_1F{x}};
                legs = {[-1,2,3],[2,4,-3,1],[3,5,1,-4],[-2,4,5]};
                l1_1 = ncon(tensors,legs);
                l1_1 = reshape(l1_1,[bdl*bdl*d*d,1]);
                tensors = {l1_2c,A{x},B{x},L1_2F{x}};
                legs = {[-1,2,3],[2,4,-3,1],[3,5,1,-4],[-2,4,5]};
                l1_2 = ncon(tensors,legs);
                l1_2 = reshape(l1_2,[bdl*bdl*d*d,1]);
                tensors = {l1_0bc,A{x},A{x},L1_0BF{x}};
                legs = {[-1,2,3],[2,4,-4,1],[3,5,1,-3],[-2,4,5]};
                l1_0b = ncon(tensors,legs);
                l1_0b = reshape(l1_0b,[bdl*bdl*d*d,1]);
                tensors = {l1_3c,B{x},A{x},L1_3F{x}};
                legs = {[-1,2,3],[2,4,-4,1],[3,5,1,-3],[-2,4,5]};
                l1_3 = ncon(tensors,legs);
                l1_3 = reshape(l1_3,[bdl*bdl*d*d,1]);
                tensors = {l1_4c,A{x},B{x},L1_4F{x}};
                legs = {[-1,2,3],[2,4,-4,1],[3,5,1,-3],[-2,4,5]};
                l1_4 = ncon(tensors,legs);
                l1_4 = reshape(l1_4,[bdl*bdl*d*d,1]);
                tensors = {l2_1c,A{x},A{x},L2_1F{x}};
                legs = {[-1,1,-5,2],[1,3,-3,-7],[2,4,-8,-4],[-2,3,-6,4]};
                l2_1 = ncon(tensors,legs);
                l2_1 = reshape(l2_1,[bdl*bdl*d*d,bdl*bdl*d*d]);
                tensors = {l2_2c,A{x},A{x},eye(d),L2_2F{x}};
                legs = {[-1,2,3,-5],[2,4,-3,1],[3,5,1,-7],[-8,-4],[-2,4,5,-6]};
                l2_2 = ncon(tensors,legs);
                l2_2 = reshape(l2_2,[bdl*bdl*d*d,bdl*bdl*d*d]);
                tensors = {l2_3c,eye(d),A{x},A{x},L2_3F{x}};
                legs = {[-1,-5,2,3],[-3,-7],[2,4,-8,1],[3,5,1,-4],[-2,-6,4,5]};
                l2_3 = ncon(tensors,legs);
                l2_3 = reshape(l2_3,[bdl*bdl*d*d,bdl*bdl*d*d]);
                dl2 = 2*l2_1+l2_2+l2_3;
                dl2 = (dl2+dl2')/2;
                dl1 = 2*(l1_1+l1_2-2*l1_0a)/phi;
                dl2pinv = pinv2(dl2,tol2);
                dl2pinv = (dl2pinv+dl2pinv')/2;
                cv = dl2pinv*dl1;
                c(:,:,:,:,x) = reshape(cv,[bdl,bdl,d,d]);
                index = index+1;
                fom2(index) = abs(1+(-2*(cv'*l1_1+cv'*l1_2-2*cv'*l1_0a+cv.'*l1_3+cv.'*l1_4-2*cv.'*l1_0b)/phi+2*cv'*l2_1*cv+cv'*l2_2*cv+cv'*l2_3*cv)/(4*l0));
                tensors = {l1_0ac,conj(c(:,:,:,:,x)),A{x},A{x}};
                legs = {[4,5,6],[4,-1,2,1],[5,-2,2,3],[6,-3,3,1]};
                l1_0ac = ncon(tensors,legs);
                tensors = {l1_1c,conj(c(:,:,:,:,x)),B{x},A{x}};
                legs = {[4,5,6],[4,-1,2,1],[5,-2,2,3],[6,-3,3,1]};
                l1_1c = ncon(tensors,legs);
                tensors = {l1_2c,conj(c(:,:,:,:,x)),A{x},B{x}};
                legs = {[4,5,6],[4,-1,2,1],[5,-2,2,3],[6,-3,3,1]};
                l1_2c = ncon(tensors,legs);
                tensors = {l1_0bc,c(:,:,:,:,x),A{x},A{x}};
                legs = {[4,5,6],[4,-1,1,2],[5,-2,2,3],[6,-3,3,1]};
                l1_0bc = ncon(tensors,legs);
                tensors = {l1_3c,c(:,:,:,:,x),B{x},A{x}};
                legs = {[4,5,6],[4,-1,1,2],[5,-2,2,3],[6,-3,3,1]};
                l1_3c = ncon(tensors,legs);
                tensors = {l1_4c,c(:,:,:,:,x),A{x},B{x}};
                legs = {[4,5,6],[4,-1,1,2],[5,-2,2,3],[6,-3,3,1]};
                l1_4c = ncon(tensors,legs);
                tensors = {l2_1c,conj(c(:,:,:,:,x)),A{x},c(:,:,:,:,x),A{x}};
                legs = {[5,6,7,8],[5,-1,2,1],[6,-2,2,3],[7,-3,3,4],[8,-4,4,1]};
                l2_1c = ncon(tensors,legs);
                tensors = {l2_2c,conj(c(:,:,:,:,x)),A{x},A{x},c(:,:,:,:,x)};
                legs = {[5,6,7,8],[5,-1,2,1],[6,-2,2,3],[7,-3,3,4],[8,-4,4,1]};
                l2_2c = ncon(tensors,legs);
                tensors = {l2_3c,conj(c(:,:,:,:,x)),c(:,:,:,:,x),A{x},A{x}};
                legs = {[5,6,7,8],[5,-1,2,1],[6,-2,2,3],[7,-3,3,4],[8,-4,4,1]};
                l2_3c = ncon(tensors,legs);
            end
            tensors = {l1_0ac,A{n},A{n}};
            legs = {[-1,2,3,-2],[2,-5,-3,1],[3,-6,1,-4]};
            l1_0a = ncon(tensors,legs);
            l1_0a = reshape(l1_0a,[bdl*d*d,1]);
            tensors = {l1_1c,B{n},A{n}};
            legs = {[-1,2,3,-2],[2,-5,-3,1],[3,-6,1,-4]};
            l1_1 = ncon(tensors,legs);
            l1_1 = reshape(l1_1,[bdl*d*d,1]);
            tensors = {l1_2c,A{n},B{n}};
            legs = {[-1,2,3,-2],[2,-5,-3,1],[3,-6,1,-4]};
            l1_2 = ncon(tensors,legs);
            l1_2 = reshape(l1_2,[bdl*d*d,1]);
            tensors = {l1_0bc,A{n},A{n}};
            legs = {[-1,2,3,-2],[2,-5,-4,1],[3,-6,1,-3]};
            l1_0b = ncon(tensors,legs);
            l1_0b = reshape(l1_0b,[bdl*d*d,1]);
            tensors = {l1_3c,B{n},A{n}};
            legs = {[-1,2,3,-2],[2,-5,-4,1],[3,-6,1,-3]};
            l1_3 = ncon(tensors,legs);
            l1_3 = reshape(l1_3,[bdl*d*d,1]);
            tensors = {l1_4c,A{n},B{n}};
            legs = {[-1,2,3,-2],[2,-5,-4,1],[3,-6,1,-3]};
            l1_4 = ncon(tensors,legs);
            l1_4 = reshape(l1_4,[bdl*d*d,1]);
            tensors = {l2_1c,A{n},A{n}};
            legs = {[-1,1,-5,2,-2,-6],[1,-9,-3,-7],[2,-10,-8,-4]};
            l2_1 = ncon(tensors,legs);
            l2_1 = reshape(l2_1,[bdl*d*d,bdl*d*d]);
            tensors = {l2_2c,A{n},A{n},eye(d)};
            legs = {[-1,2,3,-5,-2,-6],[2,-9,-3,1],[3,-10,1,-7],[-8,-4]};
            l2_2 = ncon(tensors,legs);
            l2_2 = reshape(l2_2,[bdl*d*d,bdl*d*d]);
            tensors = {l2_3c,eye(d),A{n},A{n}};
            legs = {[-1,-5,2,3,-2,-6],[-3,-7],[2,-9,-8,1],[3,-10,1,-4]};
            l2_3 = ncon(tensors,legs);
            l2_3 = reshape(l2_3,[bdl*d*d,bdl*d*d]);
            dl2 = 2*l2_1+l2_2+l2_3;
            dl2 = (dl2+dl2')/2;
            dl1 = 2*(l1_1+l1_2-2*l1_0a)/phi;
            dl2pinv = pinv2(dl2,tol2);
            dl2pinv = (dl2pinv+dl2pinv')/2;
            cv = dl2pinv*dl1;
            c(:,1,:,:,n) = reshape(cv,[bdl,1,d,d]);
            index = index+1;
            fom2(index) = abs(1+(-2*(cv'*l1_1+cv'*l1_2-2*cv'*l1_0a+cv.'*l1_3+cv.'*l1_4-2*cv.'*l1_0b)/phi+2*cv'*l2_1*cv+cv'*l2_2*cv+cv'*l2_3*cv)/(4*l0));
            if fom2(index) < 10^-10 || iter2 >= 20 || (iter2 >= 2 && std(fom2((iter2-2)*n+1:iter2*n),1)/mean(fom2((iter2-2)*n+1:iter2*n)) <= relunc2)
                break
            end
        end
    end
    fom2 = fom2(1:index);
    %plot(-log10(fom2))
    tensors = {B{n},c(:,1,:,:,n)};
    legs = {[-1,-3,1,2],[-2,-4,2,1]};
    f = ncon(tensors,legs);
    for x = n-1:-1:2
        tensors = {B{x},c(:,:,:,:,x),f};
        legs = {[-1,3,1,2],[-2,4,2,1],[3,4]};
        f = ncon(tensors,legs);
    end
    tensors = {B{1},c(1,:,:,:,1),f};
    legs = {[-1,3,1,2],[-2,4,2,1],[3,4]};
    f = ncon(tensors,legs);
    f = real(f);
end
result = f;
end