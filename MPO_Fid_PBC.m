function [result,c] = MPO_Fid_PBC(figureofmerit,n,d,bdl,lherm,imprecision,a,b,phi,c)
% Parameters
tol1 = phi;
tol2 = phi;
relunc1 = 0.1*imprecision;
relunc2 = imprecision;
global ncon_skipCheckInputs;
ncon_skipCheckInputs = true;
% Functions
function y = pinv2(x,tol)
    [uf,sf,vf] = svd(x);
    sf = diag(sf);
    positionf = sf > sf(1)*tol;
    sf2 = sf(positionf).^-1;
    sf2(end+1:numel(sf)) = 0;
    sf2 = diag(sf2);
    y = vf*sf2*uf';
end
% Calculations
%  MPO
%  2Tr(r'L)-Tr(rLL) maximization
bdrhoa = size(a,1);
bdrhob = size(b,1);
if figureofmerit == 1
    l1f = zeros([bdl,bdrhob,bdl,bdrhob,n-1]);
    l1_0f = zeros([bdl,bdrhoa,bdl,bdrhoa,n-1]);
    l2f = zeros([bdl,bdrhoa,bdl,bdl,bdrhoa,bdl,n-1]);
    fom1 = zeros([n*100,1]);
    index = 0;
    iter1 = 0;
    while 1
        iter1 = iter1+1;
        tensors = {c(:,:,:,:,n),b(:,:,:,:,n)};
        legs = {[-1,-3,1,2],[-2,-4,2,1]};
        l1f(:,:,:,:,n-1) = ncon(tensors,legs);
        tensors = {c(:,:,:,:,n),a(:,:,:,:,n)};
        legs = {[-1,-3,1,2],[-2,-4,2,1]};
        l1_0f(:,:,:,:,n-1) = ncon(tensors,legs);
        tensors = {c(:,:,:,:,n),a(:,:,:,:,n),c(:,:,:,:,n)};
        legs = {[-1,-4,1,2],[-2,-5,2,3],[-3,-6,3,1]};
        l2f(:,:,:,:,:,:,n-1) = ncon(tensors,legs);
        for x = n-1:-1:2
            tensors = {c(:,:,:,:,x),b(:,:,:,:,x),l1f(:,:,:,:,x)};
            legs = {[-1,3,1,2],[-2,4,2,1],[3,4,-3,-4]};
            l1f(:,:,:,:,x-1) = ncon(tensors,legs);
            tensors = {c(:,:,:,:,x),a(:,:,:,:,x),l1_0f(:,:,:,:,x)};
            legs = {[-1,3,1,2],[-2,4,2,1],[3,4,-3,-4]};
            l1_0f(:,:,:,:,x-1) = ncon(tensors,legs);
            tensors = {c(:,:,:,:,x),a(:,:,:,:,x),c(:,:,:,:,x),l2f(:,:,:,:,:,:,x)};
            legs = {[-1,4,1,2],[-2,5,2,3],[-3,6,3,1],[4,5,6,-4,-5,-6]};
            l2f(:,:,:,:,:,:,x-1) = ncon(tensors,legs);
        end
        tensors = {b(:,:,:,:,1),l1f(:,:,:,:,1)};
        legs = {[2,1,-4,-3],[-2,1,-1,2]};
        l1 = ncon(tensors,legs);
        l1 = reshape(l1,[bdl*bdl*d*d,1]);
        tensors = {a(:,:,:,:,1),l1_0f(:,:,:,:,1)};
        legs = {[2,1,-4,-3],[-2,1,-1,2]};
        l1_0 = ncon(tensors,legs);
        l1_0 = reshape(l1_0,[bdl*bdl*d*d,1]);
        tensors = {a(:,:,:,:,1),eye(d),l2f(:,:,:,:,:,:,1)};
        legs = {[2,1,-4,-7],[-8,-3],[-2,1,-6,-1,2,-5]};
        l2 = ncon(tensors,legs);
        l2 = reshape(l2,[bdl*bdl*d*d,bdl*bdl*d*d]);
        dl2 = l2+l2.';
        dl1 = 2*(l1-l1_0)/phi;
        dl2pinv = pinv2(dl2,tol1);
        dl2pinv = (dl2pinv+dl2pinv.')/2;
        cv = dl2pinv*dl1;
        c(:,:,:,:,1) = reshape(cv,[bdl,bdl,d,d]);
        if lherm == 1
            c(:,:,:,:,1) = (c(:,:,:,:,1)+conj(permute(c(:,:,:,:,1),[1,2,4,3])))/2;
            cv = reshape(c(:,:,:,:,1),[bdl*bdl*d*d,1]);
        end
        index = index+1;
        fom1(index) = real(2*cv.'*(l1-l1_0)/phi-cv.'*l2*cv);
        tensors = {c(:,:,:,:,1),b(:,:,:,:,1)};
        legs = {[-1,-3,1,2],[-2,-4,2,1]};
        l1c = ncon(tensors,legs);
        tensors = {c(:,:,:,:,1),a(:,:,:,:,1)};
        legs = {[-1,-3,1,2],[-2,-4,2,1]};
        l1_0c = ncon(tensors,legs);
        tensors = {c(:,:,:,:,1),a(:,:,:,:,1),c(:,:,:,:,1)};
        legs = {[-1,-4,1,2],[-2,-5,2,3],[-3,-6,3,1]};
        l2c = ncon(tensors,legs);
        for x = 2:n-1
            tensors = {l1c,b(:,:,:,:,x),l1f(:,:,:,:,x)};
            legs = {[3,4,-1,1],[1,2,-4,-3],[-2,2,3,4]};
            l1 = ncon(tensors,legs);
            l1 = reshape(l1,[bdl*bdl*d*d,1]);
            tensors = {l1_0c,a(:,:,:,:,x),l1_0f(:,:,:,:,x)};
            legs = {[3,4,-1,1],[1,2,-4,-3],[-2,2,3,4]};
            l1_0 = ncon(tensors,legs);
            l1_0 = reshape(l1_0,[bdl*bdl*d*d,1]);
            tensors = {l2c,a(:,:,:,:,x),eye(d),l2f(:,:,:,:,:,:,x)};
            legs = {[3,4,5,-1,1,-5],[1,2,-4,-7],[-8,-3],[-2,2,-6,3,4,5]};
            l2 = ncon(tensors,legs);
            l2 = reshape(l2,[bdl*bdl*d*d,bdl*bdl*d*d]);
            dl2 = l2+l2.';
            dl1 = 2*(l1-l1_0)/phi;
            dl2pinv = pinv2(dl2,tol1);
            dl2pinv = (dl2pinv+dl2pinv.')/2;
            cv = dl2pinv*dl1;
            c(:,:,:,:,x) = reshape(cv,[bdl,bdl,d,d]);
            if lherm == 1
                c(:,:,:,:,x) = (c(:,:,:,:,x)+conj(permute(c(:,:,:,:,x),[1,2,4,3])))/2;
                cv = reshape(c(:,:,:,:,x),[bdl*bdl*d*d,1]);
            end
            index = index+1;
            fom1(index) = real(2*cv.'*(l1-l1_0)/phi-cv.'*l2*cv);
            tensors = {l1c,c(:,:,:,:,x),b(:,:,:,:,x)};
            legs = {[-1,-2,3,4],[3,-3,1,2],[4,-4,2,1]};
            l1c = ncon(tensors,legs);
            tensors = {l1c,c(:,:,:,:,x),a(:,:,:,:,x)};
            legs = {[-1,-2,3,4],[3,-3,1,2],[4,-4,2,1]};
            l1_0c = ncon(tensors,legs);
            tensors = {l2c,c(:,:,:,:,x),a(:,:,:,:,x),c(:,:,:,:,x)};
            legs = {[-1,-2,-3,4,5,6],[4,-4,1,2],[5,-5,2,3],[6,-6,3,1]};
            l2c = ncon(tensors,legs);
        end
        tensors = {l1c,b(:,:,:,:,n)};
        legs = {[-2,2,-1,1],[1,2,-4,-3]};
        l1 = ncon(tensors,legs);
        l1 = reshape(l1,[bdl*bdl*d*d,1]);
        tensors = {l1_0c,a(:,:,:,:,n)};
        legs = {[-2,2,-1,1],[1,2,-4,-3]};
        l1_0 = ncon(tensors,legs);
        l1_0 = reshape(l1_0,[bdl*bdl*d*d,1]);
        tensors = {l2c,a(:,:,:,:,n),eye(d)};
        legs = {[-2,2,-6,-1,1,-5],[1,2,-4,-7],[-8,-3]};
        l2 = ncon(tensors,legs);
        l2 = reshape(l2,[bdl*bdl*d*d,bdl*bdl*d*d]);
        dl2 = l2+l2.';
        dl1 = 2*(l1-l1_0)/phi;
        dl2pinv = pinv2(dl2,tol1);
        dl2pinv = (dl2pinv+dl2pinv.')/2;
        cv = dl2pinv*dl1;
        c(:,:,:,:,n) = reshape(cv,[bdl,bdl,d,d]);
        if lherm == 1
            c(:,:,:,:,n) = (c(:,:,:,:,n)+conj(permute(c(:,:,:,:,n),[1,2,4,3])))/2;
            cv = reshape(c(:,:,:,:,n),[bdl*bdl*d*d,1]);
        end
        index = index+1;
        fom1(index) = real(2*cv.'*(l1-l1_0)/phi-cv.'*l2*cv);
        if iter1 >= 2 && all(fom1((iter1-2)*n+1:iter1*n) > 0) && std(fom1((iter1-2)*n+1:iter1*n),1)/mean(fom1((iter1-2)*n+1:iter1*n)) <= relunc1
            break
        end
    end
    fom1 = fom1(1:index);
    %plot(fom1)
    f = fom1(index);
%  ||2*r'-rL-Lr||^2/||2*r'||^2 minimization
elseif figureofmerit == 2
    tensors = {b(:,:,:,:,n),b(:,:,:,:,n)};
    legs = {[-1,-3,1,2],[-2,-4,2,1]};
    l0_1 = ncon(tensors,legs);
    for x = n-1:-1:2
        tensors = {b(:,:,:,:,x),b(:,:,:,:,x),l0_1};
        legs = {[-1,3,1,2],[-2,4,2,1],[3,4,-3,-4]};
        l0_1 = ncon(tensors,legs);
    end
    tensors = {b(:,:,:,:,1),b(:,:,:,:,1),l0_1};
    legs = {[5,3,1,2],[6,4,2,1],[3,4,5,6]};
    l0_1 = ncon(tensors,legs);
    tensors = {b(:,:,:,:,n),a(:,:,:,:,n)};
    legs = {[-1,-3,1,2],[-2,-4,2,1]};
    l0_2 = ncon(tensors,legs);
    for x = n-1:-1:2
        tensors = {b(:,:,:,:,x),a(:,:,:,:,x),l0_2};
        legs = {[-1,3,1,2],[-2,4,2,1],[3,4,-3,-4]};
        l0_2 = ncon(tensors,legs);
    end
    tensors = {b(:,:,:,:,1),a(:,:,:,:,1),l0_2};
    legs = {[5,3,1,2],[6,4,2,1],[3,4,5,6]};
    l0_2 = ncon(tensors,legs);
    tensors = {a(:,:,:,:,n),a(:,:,:,:,n)};
    legs = {[-1,-3,1,2],[-2,-4,2,1]};
    l0_3 = ncon(tensors,legs);
    for x = n-1:-1:2
        tensors = {a(:,:,:,:,x),a(:,:,:,:,x),l0_3};
        legs = {[-1,3,1,2],[-2,4,2,1],[3,4,-3,-4]};
        l0_3 = ncon(tensors,legs);
    end
    tensors = {a(:,:,:,:,1),a(:,:,:,:,1),l0_3};
    legs = {[5,3,1,2],[6,4,2,1],[3,4,5,6]};
    l0_3 = ncon(tensors,legs);
    l0 = (l0_1-2*l0_2+l0_3)/phi^2;
    l0 = abs(l0);
    if lherm == 1
        l1_0f = zeros([bdl,bdrhoa,bdrhoa,bdl,bdrhoa,bdrhoa,n-1]);
        l1_1f = zeros([bdl,bdrhob,bdrhoa,bdl,bdrhob,bdrhoa,n-1]);
        l1_2f = zeros([bdl,bdrhoa,bdrhob,bdl,bdrhoa,bdrhob,n-1]);
        l2_1f = zeros([bdl,bdrhoa,bdl,bdrhoa,bdl,bdrhoa,bdl,bdrhoa,n-1]);
        l2_2f = zeros([bdl,bdl,bdrhoa,bdrhoa,bdl,bdl,bdrhoa,bdrhoa,n-1]);
        fom2 = zeros([n*100,1]);
        index = 0;
        iter2 = 0;
        while 1
            iter2 = iter2+1;
            tensors = {c(:,:,:,:,n),a(:,:,:,:,n),a(:,:,:,:,n)};
            legs = {[-1,-4,1,2],[-2,-5,2,3],[-3,-6,3,1]};
            l1_0f(:,:,:,:,:,:,n-1) = ncon(tensors,legs);
            tensors = {c(:,:,:,:,n),b(:,:,:,:,n),a(:,:,:,:,n)};
            legs = {[-1,-4,1,2],[-2,-5,2,3],[-3,-6,3,1]};
            l1_1f(:,:,:,:,:,:,n-1) = ncon(tensors,legs);
            tensors = {c(:,:,:,:,n),a(:,:,:,:,n),b(:,:,:,:,n)};
            legs = {[-1,-4,1,2],[-2,-5,2,3],[-3,-6,3,1]};
            l1_2f(:,:,:,:,:,:,n-1) = ncon(tensors,legs);
            tensors = {c(:,:,:,:,n),a(:,:,:,:,n),c(:,:,:,:,n),a(:,:,:,:,n)};
            legs = {[-1,-5,1,2],[-2,-6,2,3],[-3,-7,3,4],[-4,-8,4,1]};
            l2_1f(:,:,:,:,:,:,:,:,n-1) = ncon(tensors,legs);
            tensors = {c(:,:,:,:,n),c(:,:,:,:,n),a(:,:,:,:,n),a(:,:,:,:,n)};
            legs = {[-1,-5,1,2],[-2,-6,2,3],[-3,-7,3,4],[-4,-8,4,1]};
            l2_2f(:,:,:,:,:,:,:,:,n-1) = ncon(tensors,legs);
            for x = n-1:-1:2
                tensors = {c(:,:,:,:,x),a(:,:,:,:,x),a(:,:,:,:,x),l1_0f(:,:,:,:,:,:,x)};
                legs = {[-1,4,1,2],[-2,5,2,3],[-3,6,3,1],[4,5,6,-4,-5,-6]};
                l1_0f(:,:,:,:,:,:,x-1) = ncon(tensors,legs);
                tensors = {c(:,:,:,:,x),b(:,:,:,:,x),a(:,:,:,:,x),l1_1f(:,:,:,:,:,:,x)};
                legs = {[-1,4,1,2],[-2,5,2,3],[-3,6,3,1],[4,5,6,-4,-5,-6]};
                l1_1f(:,:,:,:,:,:,x-1) = ncon(tensors,legs);
                tensors = {c(:,:,:,:,x),a(:,:,:,:,x),b(:,:,:,:,x),l1_2f(:,:,:,:,:,:,x)};
                legs = {[-1,4,1,2],[-2,5,2,3],[-3,6,3,1],[4,5,6,-4,-5,-6]};
                l1_2f(:,:,:,:,:,:,x-1) = ncon(tensors,legs);
                tensors = {c(:,:,:,:,x),a(:,:,:,:,x),c(:,:,:,:,x),a(:,:,:,:,x),l2_1f(:,:,:,:,:,:,:,:,x)};
                legs = {[-1,5,1,2],[-2,6,2,3],[-3,7,3,4],[-4,8,4,1],[5,6,7,8,-5,-6,-7,-8]};
                l2_1f(:,:,:,:,:,:,:,:,x-1) = ncon(tensors,legs);
                tensors = {c(:,:,:,:,x),c(:,:,:,:,x),a(:,:,:,:,x),a(:,:,:,:,x),l2_2f(:,:,:,:,:,:,:,:,x)};
                legs = {[-1,5,1,2],[-2,6,2,3],[-3,7,3,4],[-4,8,4,1],[5,6,7,8,-5,-6,-7,-8]};
                l2_2f(:,:,:,:,:,:,:,:,x-1) = ncon(tensors,legs);
            end
            tensors = {a(:,:,:,:,1),a(:,:,:,:,1),l1_0f(:,:,:,:,:,:,1)};
            legs = {[4,2,-4,1],[5,3,1,-3],[-2,2,3,-1,4,5]};
            l1_0 = ncon(tensors,legs);
            l1_0 = reshape(l1_0,[bdl*bdl*d*d,1]);
            tensors = {b(:,:,:,:,1),a(:,:,:,:,1),l1_1f(:,:,:,:,:,:,1)};
            legs = {[4,2,-4,1],[5,3,1,-3],[-2,2,3,-1,4,5]};
            l1_1 = ncon(tensors,legs);
            l1_1 = reshape(l1_1,[bdl*bdl*d*d,1]);
            tensors = {a(:,:,:,:,1),b(:,:,:,:,1),l1_2f(:,:,:,:,:,:,1)};
            legs = {[4,2,-4,1],[5,3,1,-3],[-2,2,3,-1,4,5]};
            l1_2 = ncon(tensors,legs);
            l1_2 = reshape(l1_2,[bdl*bdl*d*d,1]);
            tensors = {a(:,:,:,:,1),a(:,:,:,:,1),l2_1f(:,:,:,:,:,:,:,:,1)};
            legs = {[2,1,-4,-7],[4,3,-8,-3],[-2,1,-6,3,-1,2,-5,4]};
            l2_1 = ncon(tensors,legs);
            l2_1 = reshape(l2_1,[bdl*bdl*d*d,bdl*bdl*d*d]);
            tensors = {eye(d),a(:,:,:,:,1),a(:,:,:,:,1),l2_2f(:,:,:,:,:,:,:,:,1)};
            legs = {[-4,-7],[4,2,-8,1],[5,3,1,-3],[-2,-6,2,3,-1,-5,4,5]};
            l2_2 = ncon(tensors,legs);
            l2_2 = reshape(l2_2,[bdl*bdl*d*d,bdl*bdl*d*d]);
            dl2 = l2_1+l2_1.'+l2_2+l2_2.';
            dl1 = 2*(l1_1+l1_2-2*l1_0)/phi;
            dl2pinv = pinv2(dl2,tol2);
            dl2pinv = (dl2pinv+dl2pinv.')/2;
            cv = dl2pinv*dl1;
            c(:,:,:,:,1) = reshape(cv,[bdl,bdl,d,d]);
            c(:,:,:,:,1) = (c(:,:,:,:,1)+conj(permute(c(:,:,:,:,1),[1,2,4,3])))/2;
            cv = reshape(c(:,:,:,:,1),[bdl*bdl*d*d,1]);
            index = index+1;
            fom2(index) = abs(1+(-4*(cv.'*l1_1+cv.'*l1_2-2*cv.'*l1_0)/phi+2*(cv.'*l2_1*cv+cv.'*l2_2*cv))/(4*l0));
            tensors = {c(:,:,:,:,1),a(:,:,:,:,1),a(:,:,:,:,1)};
            legs = {[-1,-4,1,2],[-2,-5,2,3],[-3,-6,3,1]};
            l1_0c = ncon(tensors,legs);
            tensors = {c(:,:,:,:,1),b(:,:,:,:,1),a(:,:,:,:,1)};
            legs = {[-1,-4,1,2],[-2,-5,2,3],[-3,-6,3,1]};
            l1_1c = ncon(tensors,legs);
            tensors = {c(:,:,:,:,1),a(:,:,:,:,1),b(:,:,:,:,1)};
            legs = {[-1,-4,1,2],[-2,-5,2,3],[-3,-6,3,1]};
            l1_2c = ncon(tensors,legs);
            tensors = {c(:,:,:,:,1),a(:,:,:,:,1),c(:,:,:,:,1),a(:,:,:,:,1)};
            legs = {[-1,-5,1,2],[-2,-6,2,3],[-3,-7,3,4],[-4,-8,4,1]};
            l2_1c = ncon(tensors,legs);
            tensors = {c(:,:,:,:,1),c(:,:,:,:,1),a(:,:,:,:,1),a(:,:,:,:,1)};
            legs = {[-1,-5,1,2],[-2,-6,2,3],[-3,-7,3,4],[-4,-8,4,1]};
            l2_2c = ncon(tensors,legs);
            for x = 2:n-1
                tensors = {l1_0c,a(:,:,:,:,x),a(:,:,:,:,x),l1_0f(:,:,:,:,:,:,x)};
                legs = {[6,7,8,-1,2,3],[2,4,-4,1],[3,5,1,-3],[-2,4,5,6,7,8]};
                l1_0 = ncon(tensors,legs);
                l1_0 = reshape(l1_0,[bdl*bdl*d*d,1]);
                tensors = {l1_1c,b(:,:,:,:,x),a(:,:,:,:,x),l1_1f(:,:,:,:,:,:,x)};
                legs = {[6,7,8,-1,2,3],[2,4,-4,1],[3,5,1,-3],[-2,4,5,6,7,8]};
                l1_1 = ncon(tensors,legs);
                l1_1 = reshape(l1_1,[bdl*bdl*d*d,1]);
                tensors = {l1_2c,a(:,:,:,:,x),b(:,:,:,:,x),l1_2f(:,:,:,:,:,:,x)};
                legs = {[6,7,8,-1,2,3],[2,4,-4,1],[3,5,1,-3],[-2,4,5,6,7,8]};
                l1_2 = ncon(tensors,legs);
                l1_2 = reshape(l1_2,[bdl*bdl*d*d,1]);
                tensors = {l2_1c,a(:,:,:,:,x),a(:,:,:,:,x),l2_1f(:,:,:,:,:,:,:,:,x)};
                legs = {[5,6,7,8,-1,1,-5,2],[1,3,-4,-7],[2,4,-8,-3],[-2,3,-6,4,5,6,7,8]};
                l2_1 = ncon(tensors,legs);
                l2_1 = reshape(l2_1,[bdl*bdl*d*d,bdl*bdl*d*d]);
                tensors = {l2_2c,eye(d),a(:,:,:,:,x),a(:,:,:,:,x),l2_2f(:,:,:,:,:,:,:,:,x)};
                legs = {[6,7,8,9,-1,-5,2,3],[-4,-7],[2,4,-8,1],[3,5,1,-3],[-2,-6,4,5,6,7,8,9]};
                l2_2 = ncon(tensors,legs);
                l2_2 = reshape(l2_2,[bdl*bdl*d*d,bdl*bdl*d*d]);
                dl2 = l2_1+l2_1.'+l2_2+l2_2.';
                dl1 = 2*(l1_1+l1_2-2*l1_0)/phi;
                dl2pinv = pinv2(dl2,tol2);
                dl2pinv = (dl2pinv+dl2pinv.')/2;
                cv = dl2pinv*dl1;
                c(:,:,:,:,x) = reshape(cv,[bdl,bdl,d,d]);
                c(:,:,:,:,x) = (c(:,:,:,:,x)+conj(permute(c(:,:,:,:,x),[1,2,4,3])))/2;
                cv = reshape(c(:,:,:,:,x),[bdl*bdl*d*d,1]);
                index = index+1;
                fom2(index) = abs(1+(-4*(cv.'*l1_1+cv.'*l1_2-2*cv.'*l1_0)/phi+2*(cv.'*l2_1*cv+cv.'*l2_2*cv))/(4*l0));
                tensors = {l1_0c,c(:,:,:,:,x),a(:,:,:,:,x),a(:,:,:,:,x)};
                legs = {[-1,-2,-3,4,5,6],[4,-4,1,2],[5,-5,2,3],[6,-6,3,1]};
                l1_0c = ncon(tensors,legs);
                tensors = {l1_1c,c(:,:,:,:,x),b(:,:,:,:,x),a(:,:,:,:,x)};
                legs = {[-1,-2,-3,4,5,6],[4,-4,1,2],[5,-5,2,3],[6,-6,3,1]};
                l1_1c = ncon(tensors,legs);
                tensors = {l1_2c,c(:,:,:,:,x),a(:,:,:,:,x),b(:,:,:,:,x)};
                legs = {[-1,-2,-3,4,5,6],[4,-4,1,2],[5,-5,2,3],[6,-6,3,1]};
                l1_2c = ncon(tensors,legs);
                tensors = {l2_1c,c(:,:,:,:,x),a(:,:,:,:,x),c(:,:,:,:,x),a(:,:,:,:,x)};
                legs = {[-1,-2,-3,-4,5,6,7,8],[5,-5,1,2],[6,-6,2,3],[7,-7,3,4],[8,-8,4,1]};
                l2_1c = ncon(tensors,legs);
                tensors = {l2_2c,c(:,:,:,:,x),c(:,:,:,:,x),a(:,:,:,:,x),a(:,:,:,:,x)};
                legs = {[-1,-2,-3,-4,5,6,7,8],[5,-5,1,2],[6,-6,2,3],[7,-7,3,4],[8,-8,4,1]};
                l2_2c = ncon(tensors,legs);
            end
            tensors = {l1_0c,a(:,:,:,:,n),a(:,:,:,:,n)};
            legs = {[-2,4,5,-1,2,3],[2,4,-4,1],[3,5,1,-3]};
            l1_0 = ncon(tensors,legs);
            l1_0 = reshape(l1_0,[bdl*bdl*d*d,1]);
            tensors = {l1_1c,b(:,:,:,:,n),a(:,:,:,:,n)};
            legs = {[-2,4,5,-1,2,3],[2,4,-4,1],[3,5,1,-3]};
            l1_1 = ncon(tensors,legs);
            l1_1 = reshape(l1_1,[bdl*bdl*d*d,1]);
            tensors = {l1_2c,a(:,:,:,:,n),b(:,:,:,:,n)};
            legs = {[-2,4,5,-1,2,3],[2,4,-4,1],[3,5,1,-3]};
            l1_2 = ncon(tensors,legs);
            l1_2 = reshape(l1_2,[bdl*bdl*d*d,1]);
            tensors = {l2_1c,a(:,:,:,:,n),a(:,:,:,:,n)};
            legs = {[-2,2,-6,4,-1,1,-5,3],[1,2,-4,-7],[3,4,-8,-3]};
            l2_1 = ncon(tensors,legs);
            l2_1 = reshape(l2_1,[bdl*bdl*d*d,bdl*bdl*d*d]);
            tensors = {l2_2c,eye(d),a(:,:,:,:,n),a(:,:,:,:,n)};
            legs = {[-2,-6,4,5,-1,-5,2,3],[-4,-7],[2,4,-8,1],[3,5,1,-3]};
            l2_2 = ncon(tensors,legs);
            l2_2 = reshape(l2_2,[bdl*bdl*d*d,bdl*bdl*d*d]);
            dl2 = l2_1+l2_1.'+l2_2+l2_2.';
            dl1 = 2*(l1_1+l1_2-2*l1_0)/phi;
            dl2pinv = pinv2(dl2,tol2);
            dl2pinv = (dl2pinv+dl2pinv.')/2;
            cv = dl2pinv*dl1;
            c(:,:,:,:,n) = reshape(cv,[bdl,bdl,d,d]);
            c(:,:,:,:,n) = (c(:,:,:,:,n)+conj(permute(c(:,:,:,:,n),[1,2,4,3])))/2;
            cv = reshape(c(:,:,:,:,n),[bdl*bdl*d*d,1]);
            index = index+1;
            fom2(index) = abs(1+(-4*(cv.'*l1_1+cv.'*l1_2-2*cv.'*l1_0)/phi+2*(cv.'*l2_1*cv+cv.'*l2_2*cv))/(4*l0));
            if fom2(index) < 10^-10 || iter2 >= 20 || (iter2 >= 2 && std(fom2((iter2-2)*n+1:iter2*n),1)/mean(fom2((iter2-2)*n+1:iter2*n)) <= relunc2)
                break
            end
        end
    else
        l1_0af = zeros([bdl,bdrhoa,bdrhoa,bdl,bdrhoa,bdrhoa,n-1]);
        l1_1f = zeros([bdl,bdrhob,bdrhoa,bdl,bdrhob,bdrhoa,n-1]);
        l1_2f = zeros([bdl,bdrhoa,bdrhob,bdl,bdrhoa,bdrhob,n-1]);
        l1_0bf = zeros([bdl,bdrhoa,bdrhoa,bdl,bdrhoa,bdrhoa,n-1]);
        l1_3f = zeros([bdl,bdrhob,bdrhoa,bdl,bdrhob,bdrhoa,n-1]);
        l1_4f = zeros([bdl,bdrhoa,bdrhob,bdl,bdrhoa,bdrhob,n-1]);
        l2_1f = zeros([bdl,bdrhoa,bdl,bdrhoa,bdl,bdrhoa,bdl,bdrhoa,n-1]);
        l2_2f = zeros([bdl,bdrhoa,bdrhoa,bdl,bdl,bdrhoa,bdrhoa,bdl,n-1]);
        l2_3f = zeros([bdl,bdl,bdrhoa,bdrhoa,bdl,bdl,bdrhoa,bdrhoa,n-1]);
        fom2 = zeros([n*100,1]);
        index = 0;
        iter2 = 0;
        while 1
            iter2 = iter2+1;
            tensors = {conj(c(:,:,:,:,n)),a(:,:,:,:,n),a(:,:,:,:,n)};
            legs = {[-1,-4,2,1],[-2,-5,2,3],[-3,-6,3,1]};
            l1_0af(:,:,:,:,:,:,n-1) = ncon(tensors,legs);
            tensors = {conj(c(:,:,:,:,n)),b(:,:,:,:,n),a(:,:,:,:,n)};
            legs = {[-1,-4,2,1],[-2,-5,2,3],[-3,-6,3,1]};
            l1_1f(:,:,:,:,:,:,n-1) = ncon(tensors,legs);
            tensors = {conj(c(:,:,:,:,n)),a(:,:,:,:,n),b(:,:,:,:,n)};
            legs = {[-1,-4,2,1],[-2,-5,2,3],[-3,-6,3,1]};
            l1_2f(:,:,:,:,:,:,n-1) = ncon(tensors,legs);
            tensors = {c(:,:,:,:,n),a(:,:,:,:,n),a(:,:,:,:,n)};
            legs = {[-1,-4,1,2],[-2,-5,2,3],[-3,-6,3,1]};
            l1_0bf(:,:,:,:,:,:,n-1) = ncon(tensors,legs);
            tensors = {c(:,:,:,:,n),b(:,:,:,:,n),a(:,:,:,:,n)};
            legs = {[-1,-4,1,2],[-2,-5,2,3],[-3,-6,3,1]};
            l1_3f(:,:,:,:,:,:,n-1) = ncon(tensors,legs);
            tensors = {c(:,:,:,:,n),a(:,:,:,:,n),b(:,:,:,:,n)};
            legs = {[-1,-4,1,2],[-2,-5,2,3],[-3,-6,3,1]};
            l1_4f(:,:,:,:,:,:,n-1) = ncon(tensors,legs);
            tensors = {conj(c(:,:,:,:,n)),a(:,:,:,:,n),c(:,:,:,:,n),a(:,:,:,:,n)};
            legs = {[-1,-5,2,1],[-2,-6,2,3],[-3,-7,3,4],[-4,-8,4,1]};
            l2_1f(:,:,:,:,:,:,:,:,n-1) = ncon(tensors,legs);
            tensors = {conj(c(:,:,:,:,n)),a(:,:,:,:,n),a(:,:,:,:,n),c(:,:,:,:,n)};
            legs = {[-1,-5,2,1],[-2,-6,2,3],[-3,-7,3,4],[-4,-8,4,1]};
            l2_2f(:,:,:,:,:,:,:,:,n-1) = ncon(tensors,legs);
            tensors = {conj(c(:,:,:,:,n)),c(:,:,:,:,n),a(:,:,:,:,n),a(:,:,:,:,n)};
            legs = {[-1,-5,2,1],[-2,-6,2,3],[-3,-7,3,4],[-4,-8,4,1]};
            l2_3f(:,:,:,:,:,:,:,:,n-1) = ncon(tensors,legs);
            for x = n-1:-1:2
                tensors = {conj(c(:,:,:,:,x)),a(:,:,:,:,x),a(:,:,:,:,x),l1_0af(:,:,:,:,:,:,x)};
                legs = {[-1,4,2,1],[-2,5,2,3],[-3,6,3,1],[4,5,6,-4,-5,-6]};
                l1_0af(:,:,:,:,:,:,x-1) = ncon(tensors,legs);
                tensors = {conj(c(:,:,:,:,x)),b(:,:,:,:,x),a(:,:,:,:,x),l1_1f(:,:,:,:,:,:,x)};
                legs = {[-1,4,2,1],[-2,5,2,3],[-3,6,3,1],[4,5,6,-4,-5,-6]};
                l1_1f(:,:,:,:,:,:,x-1) = ncon(tensors,legs);
                tensors = {conj(c(:,:,:,:,x)),a(:,:,:,:,x),b(:,:,:,:,x),l1_2f(:,:,:,:,:,:,x)};
                legs = {[-1,4,2,1],[-2,5,2,3],[-3,6,3,1],[4,5,6,-4,-5,-6]};
                l1_2f(:,:,:,:,:,:,x-1) = ncon(tensors,legs);
                tensors = {c(:,:,:,:,x),a(:,:,:,:,x),a(:,:,:,:,x),l1_0bf(:,:,:,:,:,:,x)};
                legs = {[-1,4,1,2],[-2,5,2,3],[-3,6,3,1],[4,5,6,-4,-5,-6]};
                l1_0bf(:,:,:,:,:,:,x-1) = ncon(tensors,legs);
                tensors = {c(:,:,:,:,x),b(:,:,:,:,x),a(:,:,:,:,x),l1_3f(:,:,:,:,:,:,x)};
                legs = {[-1,4,1,2],[-2,5,2,3],[-3,6,3,1],[4,5,6,-4,-5,-6]};
                l1_3f(:,:,:,:,:,:,x-1) = ncon(tensors,legs);
                tensors = {c(:,:,:,:,x),a(:,:,:,:,x),b(:,:,:,:,x),l1_4f(:,:,:,:,:,:,x)};
                legs = {[-1,4,1,2],[-2,5,2,3],[-3,6,3,1],[4,5,6,-4,-5,-6]};
                l1_4f(:,:,:,:,:,:,x-1) = ncon(tensors,legs);
                tensors = {conj(c(:,:,:,:,x)),a(:,:,:,:,x),c(:,:,:,:,x),a(:,:,:,:,x),l2_1f(:,:,:,:,:,:,:,:,x)};
                legs = {[-1,5,2,1],[-2,6,2,3],[-3,7,3,4],[-4,8,4,1],[5,6,7,8,-5,-6,-7,-8]};
                l2_1f(:,:,:,:,:,:,:,:,x-1) = ncon(tensors,legs);
                tensors = {conj(c(:,:,:,:,x)),a(:,:,:,:,x),a(:,:,:,:,x),c(:,:,:,:,x),l2_2f(:,:,:,:,:,:,:,:,x)};
                legs = {[-1,5,2,1],[-2,6,2,3],[-3,7,3,4],[-4,8,4,1],[5,6,7,8,-5,-6,-7,-8]};
                l2_2f(:,:,:,:,:,:,:,:,x-1) = ncon(tensors,legs);
                tensors = {conj(c(:,:,:,:,x)),c(:,:,:,:,x),a(:,:,:,:,x),a(:,:,:,:,x),l2_3f(:,:,:,:,:,:,:,:,x)};
                legs = {[-1,5,2,1],[-2,6,2,3],[-3,7,3,4],[-4,8,4,1],[5,6,7,8,-5,-6,-7,-8]};
                l2_3f(:,:,:,:,:,:,:,:,x-1) = ncon(tensors,legs);
            end
            tensors = {a(:,:,:,:,1),a(:,:,:,:,1),l1_0af(:,:,:,:,:,:,1)};
            legs = {[4,2,-3,1],[5,3,1,-4],[-2,2,3,-1,4,5]};
            l1_0a = ncon(tensors,legs);
            l1_0a = reshape(l1_0a,[bdl*bdl*d*d,1]);
            tensors = {b(:,:,:,:,1),a(:,:,:,:,1),l1_1f(:,:,:,:,:,:,1)};
            legs = {[4,2,-3,1],[5,3,1,-4],[-2,2,3,-1,4,5]};
            l1_1 = ncon(tensors,legs);
            l1_1 = reshape(l1_1,[bdl*bdl*d*d,1]);
            tensors = {a(:,:,:,:,1),b(:,:,:,:,1),l1_2f(:,:,:,:,:,:,1)};
            legs = {[4,2,-3,1],[5,3,1,-4],[-2,2,3,-1,4,5]};
            l1_2 = ncon(tensors,legs);
            l1_2 = reshape(l1_2,[bdl*bdl*d*d,1]);
            tensors = {a(:,:,:,:,1),a(:,:,:,:,1),l1_0bf(:,:,:,:,:,:,1)};
            legs = {[4,2,-4,1],[5,3,1,-3],[-2,2,3,-1,4,5]};
            l1_0b = ncon(tensors,legs);
            l1_0b = reshape(l1_0b,[bdl*bdl*d*d,1]);
            tensors = {b(:,:,:,:,1),a(:,:,:,:,1),l1_3f(:,:,:,:,:,:,1)};
            legs = {[4,2,-4,1],[5,3,1,-3],[-2,2,3,-1,4,5]};
            l1_3 = ncon(tensors,legs);
            l1_3 = reshape(l1_3,[bdl*bdl*d*d,1]);
            tensors = {a(:,:,:,:,1),b(:,:,:,:,1),l1_4f(:,:,:,:,:,:,1)};
            legs = {[4,2,-4,1],[5,3,1,-3],[-2,2,3,-1,4,5]};
            l1_4 = ncon(tensors,legs);
            l1_4 = reshape(l1_4,[bdl*bdl*d*d,1]);
            tensors = {a(:,:,:,:,1),a(:,:,:,:,1),l2_1f(:,:,:,:,:,:,:,:,1)};
            legs = {[2,1,-3,-7],[4,3,-8,-4],[-2,1,-6,3,-1,2,-5,4]};
            l2_1 = ncon(tensors,legs);
            l2_1 = reshape(l2_1,[bdl*bdl*d*d,bdl*bdl*d*d]);
            tensors = {a(:,:,:,:,1),a(:,:,:,:,1),eye(d),l2_2f(:,:,:,:,:,:,:,:,1)};
            legs = {[4,2,-3,1],[5,3,1,-7],[-8,-4],[-2,2,3,-6,-1,4,5,-5]};
            l2_2 = ncon(tensors,legs);
            l2_2 = reshape(l2_2,[bdl*bdl*d*d,bdl*bdl*d*d]);
            tensors = {eye(d),a(:,:,:,:,1),a(:,:,:,:,1),l2_3f(:,:,:,:,:,:,:,:,1)};
            legs = {[-3,-7],[4,2,-8,1],[5,3,1,-4],[-2,-6,2,3,-1,-5,4,5]};
            l2_3 = ncon(tensors,legs);
            l2_3 = reshape(l2_3,[bdl*bdl*d*d,bdl*bdl*d*d]);
            dl2 = 2*l2_1+l2_2+l2_3;
            dl2 = (dl2+dl2')/2;
            dl1 = 2*(l1_1+l1_2-2*l1_0a)/phi;
            dl2pinv = pinv2(dl2,tol2);
            dl2pinv = (dl2pinv+dl2pinv')/2;
            cv = dl2pinv*dl1;
            c(:,:,:,:,1) = reshape(cv,[bdl,bdl,d,d]);
            index = index+1;
            fom2(index) = abs(1+(-2*(cv'*l1_1+cv'*l1_2-2*cv'*l1_0a+cv.'*l1_3+cv.'*l1_4-2*cv.'*l1_0b)/phi+2*cv'*l2_1*cv+cv'*l2_2*cv+cv'*l2_3*cv)/(4*l0));
            tensors = {conj(c(:,:,:,:,1)),a(:,:,:,:,1),a(:,:,:,:,1)};
            legs = {[-1,-4,2,1],[-2,-5,2,3],[-3,-6,3,1]};
            l1_0ac = ncon(tensors,legs);
            tensors = {conj(c(:,:,:,:,1)),b(:,:,:,:,1),a(:,:,:,:,1)};
            legs = {[-1,-4,2,1],[-2,-5,2,3],[-3,-6,3,1]};
            l1_1c = ncon(tensors,legs);
            tensors = {conj(c(:,:,:,:,1)),a(:,:,:,:,1),b(:,:,:,:,1)};
            legs = {[-1,-4,2,1],[-2,-5,2,3],[-3,-6,3,1]};
            l1_2c = ncon(tensors,legs);
            tensors = {c(:,:,:,:,1),a(:,:,:,:,1),a(:,:,:,:,1)};
            legs = {[-1,-4,1,2],[-2,-5,2,3],[-3,-6,3,1]};
            l1_0bc = ncon(tensors,legs);
            tensors = {c(:,:,:,:,1),b(:,:,:,:,1),a(:,:,:,:,1)};
            legs = {[-1,-4,1,2],[-2,-5,2,3],[-3,-6,3,1]};
            l1_3c = ncon(tensors,legs);
            tensors = {c(:,:,:,:,1),a(:,:,:,:,1),b(:,:,:,:,1)};
            legs = {[-1,-4,1,2],[-2,-5,2,3],[-3,-6,3,1]};
            l1_4c = ncon(tensors,legs);
            tensors = {conj(c(:,:,:,:,1)),a(:,:,:,:,1),c(:,:,:,:,1),a(:,:,:,:,1)};
            legs = {[-1,-5,2,1],[-2,-6,2,3],[-3,-7,3,4],[-4,-8,4,1]};
            l2_1c = ncon(tensors,legs);
            tensors = {conj(c(:,:,:,:,1)),a(:,:,:,:,1),a(:,:,:,:,1),c(:,:,:,:,1)};
            legs = {[-1,-5,2,1],[-2,-6,2,3],[-3,-7,3,4],[-4,-8,4,1]};
            l2_2c = ncon(tensors,legs);
            tensors = {conj(c(:,:,:,:,1)),c(:,:,:,:,1),a(:,:,:,:,1),a(:,:,:,:,1)};
            legs = {[-1,-5,2,1],[-2,-6,2,3],[-3,-7,3,4],[-4,-8,4,1]};
            l2_3c = ncon(tensors,legs);
            for x = 2:n-1
                tensors = {l1_0ac,a(:,:,:,:,x),a(:,:,:,:,x),l1_0af(:,:,:,:,:,:,x)};
                legs = {[6,7,8,-1,2,3],[2,4,-3,1],[3,5,1,-4],[-2,4,5,6,7,8]};
                l1_0a = ncon(tensors,legs);
                l1_0a = reshape(l1_0a,[bdl*bdl*d*d,1]);
                tensors = {l1_1c,b(:,:,:,:,x),a(:,:,:,:,x),l1_1f(:,:,:,:,:,:,x)};
                legs = {[6,7,8,-1,2,3],[2,4,-3,1],[3,5,1,-4],[-2,4,5,6,7,8]};
                l1_1 = ncon(tensors,legs);
                l1_1 = reshape(l1_1,[bdl*bdl*d*d,1]);
                tensors = {l1_2c,a(:,:,:,:,x),b(:,:,:,:,x),l1_2f(:,:,:,:,:,:,x)};
                legs = {[6,7,8,-1,2,3],[2,4,-3,1],[3,5,1,-4],[-2,4,5,6,7,8]};
                l1_2 = ncon(tensors,legs);
                l1_2 = reshape(l1_2,[bdl*bdl*d*d,1]);
                tensors = {l1_0bc,a(:,:,:,:,x),a(:,:,:,:,x),l1_0bf(:,:,:,:,:,:,x)};
                legs = {[6,7,8,-1,2,3],[2,4,-4,1],[3,5,1,-3],[-2,4,5,6,7,8]};
                l1_0b = ncon(tensors,legs);
                l1_0b = reshape(l1_0b,[bdl*bdl*d*d,1]);
                tensors = {l1_3c,b(:,:,:,:,x),a(:,:,:,:,x),l1_3f(:,:,:,:,:,:,x)};
                legs = {[6,7,8,-1,2,3],[2,4,-4,1],[3,5,1,-3],[-2,4,5,6,7,8]};
                l1_3 = ncon(tensors,legs);
                l1_3 = reshape(l1_3,[bdl*bdl*d*d,1]);
                tensors = {l1_4c,a(:,:,:,:,x),b(:,:,:,:,x),l1_4f(:,:,:,:,:,:,x)};
                legs = {[6,7,8,-1,2,3],[2,4,-4,1],[3,5,1,-3],[-2,4,5,6,7,8]};
                l1_4 = ncon(tensors,legs);
                l1_4 = reshape(l1_4,[bdl*bdl*d*d,1]);
                tensors = {l2_1c,a(:,:,:,:,x),a(:,:,:,:,x),l2_1f(:,:,:,:,:,:,:,:,x)};
                legs = {[5,6,7,8,-1,1,-5,2],[1,3,-3,-7],[2,4,-8,-4],[-2,3,-6,4,5,6,7,8]};
                l2_1 = ncon(tensors,legs);
                l2_1 = reshape(l2_1,[bdl*bdl*d*d,bdl*bdl*d*d]);
                tensors = {l2_2c,a(:,:,:,:,x),a(:,:,:,:,x),eye(d),l2_2f(:,:,:,:,:,:,:,:,x)};
                legs = {[6,7,8,9,-1,2,3,-5],[2,4,-3,1],[3,5,1,-7],[-8,-4],[-2,4,5,-6,6,7,8,9]};
                l2_2 = ncon(tensors,legs);
                l2_2 = reshape(l2_2,[bdl*bdl*d*d,bdl*bdl*d*d]);
                tensors = {l2_3c,eye(d),a(:,:,:,:,x),a(:,:,:,:,x),l2_3f(:,:,:,:,:,:,:,:,x)};
                legs = {[6,7,8,9,-1,-5,2,3],[-3,-7],[2,4,-8,1],[3,5,1,-4],[-2,-6,4,5,6,7,8,9]};
                l2_3 = ncon(tensors,legs);
                l2_3 = reshape(l2_3,[bdl*bdl*d*d,bdl*bdl*d*d]);
                dl2 = 2*l2_1+l2_2+l2_3;
                dl2 = (dl2+dl2')/2;
                dl1 = 2*(l1_1+l1_2-2*l1_0a)/phi;
                dl2pinv = pinv2(dl2,tol2);
                dl2pinv = (dl2pinv+dl2pinv')/2;
                cv = dl2pinv*dl1;
                c(:,:,:,:,x) = reshape(cv,[bdl,bdl,d,d]);
                index = index+1;
                fom2(index) = abs(1+(-2*(cv'*l1_1+cv'*l1_2-2*cv'*l1_0a+cv.'*l1_3+cv.'*l1_4-2*cv.'*l1_0b)/phi+2*cv'*l2_1*cv+cv'*l2_2*cv+cv'*l2_3*cv)/(4*l0));
                tensors = {l1_0ac,conj(c(:,:,:,:,x)),a(:,:,:,:,x),a(:,:,:,:,x)};
                legs = {[-1,-2,-3,4,5,6],[4,-4,2,1],[5,-5,2,3],[6,-6,3,1]};
                l1_0ac = ncon(tensors,legs);
                tensors = {l1_1c,conj(c(:,:,:,:,x)),b(:,:,:,:,x),a(:,:,:,:,x)};
                legs = {[-1,-2,-3,4,5,6],[4,-4,2,1],[5,-5,2,3],[6,-6,3,1]};
                l1_1c = ncon(tensors,legs);
                tensors = {l1_2c,conj(c(:,:,:,:,x)),a(:,:,:,:,x),b(:,:,:,:,x)};
                legs = {[-1,-2,-3,4,5,6],[4,-4,2,1],[5,-5,2,3],[6,-6,3,1]};
                l1_2c = ncon(tensors,legs);
                tensors = {l1_0bc,c(:,:,:,:,x),a(:,:,:,:,x),a(:,:,:,:,x)};
                legs = {[-1,-2,-3,4,5,6],[4,-4,1,2],[5,-5,2,3],[6,-6,3,1]};
                l1_0bc = ncon(tensors,legs);
                tensors = {l1_3c,c(:,:,:,:,x),b(:,:,:,:,x),a(:,:,:,:,x)};
                legs = {[-1,-2,-3,4,5,6],[4,-4,1,2],[5,-5,2,3],[6,-6,3,1]};
                l1_3c = ncon(tensors,legs);
                tensors = {l1_4c,c(:,:,:,:,x),a(:,:,:,:,x),b(:,:,:,:,x)};
                legs = {[-1,-2,-3,4,5,6],[4,-4,1,2],[5,-5,2,3],[6,-6,3,1]};
                l1_4c = ncon(tensors,legs);
                tensors = {l2_1c,conj(c(:,:,:,:,x)),a(:,:,:,:,x),c(:,:,:,:,x),a(:,:,:,:,x)};
                legs = {[-1,-2,-3,-4,5,6,7,8],[5,-5,2,1],[6,-6,2,3],[7,-7,3,4],[8,-8,4,1]};
                l2_1c = ncon(tensors,legs);
                tensors = {l2_2c,conj(c(:,:,:,:,x)),a(:,:,:,:,x),a(:,:,:,:,x),c(:,:,:,:,x)};
                legs = {[-1,-2,-3,-4,5,6,7,8],[5,-5,2,1],[6,-6,2,3],[7,-7,3,4],[8,-8,4,1]};
                l2_2c = ncon(tensors,legs);
                tensors = {l2_3c,conj(c(:,:,:,:,x)),c(:,:,:,:,x),a(:,:,:,:,x),a(:,:,:,:,x)};
                legs = {[-1,-2,-3,-4,5,6,7,8],[5,-5,2,1],[6,-6,2,3],[7,-7,3,4],[8,-8,4,1]};
                l2_3c = ncon(tensors,legs);
            end
            tensors = {l1_0ac,a(:,:,:,:,n),a(:,:,:,:,n)};
            legs = {[-2,4,5,-1,2,3],[2,4,-3,1],[3,5,1,-4]};
            l1_0a = ncon(tensors,legs);
            l1_0a = reshape(l1_0a,[bdl*bdl*d*d,1]);
            tensors = {l1_1c,b(:,:,:,:,n),a(:,:,:,:,n)};
            legs = {[-2,4,5,-1,2,3],[2,4,-3,1],[3,5,1,-4]};
            l1_1 = ncon(tensors,legs);
            l1_1 = reshape(l1_1,[bdl*bdl*d*d,1]);
            tensors = {l1_2c,a(:,:,:,:,n),b(:,:,:,:,n)};
            legs = {[-2,4,5,-1,2,3],[2,4,-3,1],[3,5,1,-4]};
            l1_2 = ncon(tensors,legs);
            l1_2 = reshape(l1_2,[bdl*bdl*d*d,1]);
            tensors = {l1_0bc,a(:,:,:,:,n),a(:,:,:,:,n)};
            legs = {[-2,4,5,-1,2,3],[2,4,-4,1],[3,5,1,-3]};
            l1_0b = ncon(tensors,legs);
            l1_0b = reshape(l1_0b,[bdl*bdl*d*d,1]);
            tensors = {l1_3c,b(:,:,:,:,n),a(:,:,:,:,n)};
            legs = {[-2,4,5,-1,2,3],[2,4,-4,1],[3,5,1,-3]};
            l1_3 = ncon(tensors,legs);
            l1_3 = reshape(l1_3,[bdl*bdl*d*d,1]);
            tensors = {l1_4c,a(:,:,:,:,n),b(:,:,:,:,n)};
            legs = {[-2,4,5,-1,2,3],[2,4,-4,1],[3,5,1,-3]};
            l1_4 = ncon(tensors,legs);
            l1_4 = reshape(l1_4,[bdl*bdl*d*d,1]);
            tensors = {l2_1c,a(:,:,:,:,n),a(:,:,:,:,n)};
            legs = {[-2,2,-6,4,-1,1,-5,3],[1,2,-3,-7],[3,4,-8,-4]};
            l2_1 = ncon(tensors,legs);
            l2_1 = reshape(l2_1,[bdl*bdl*d*d,bdl*bdl*d*d]);
            tensors = {l2_2c,a(:,:,:,:,n),a(:,:,:,:,n),eye(d)};
            legs = {[-2,4,5,-6,-1,2,3,-5],[2,4,-3,1],[3,5,1,-7],[-8,-4]};
            l2_2 = ncon(tensors,legs);
            l2_2 = reshape(l2_2,[bdl*bdl*d*d,bdl*bdl*d*d]);
            tensors = {l2_3c,eye(d),a(:,:,:,:,n),a(:,:,:,:,n)};
            legs = {[-2,-6,4,5,-1,-5,2,3],[-3,-7],[2,4,-8,1],[3,5,1,-4]};
            l2_3 = ncon(tensors,legs);
            l2_3 = reshape(l2_3,[bdl*bdl*d*d,bdl*bdl*d*d]);
            dl2 = 2*l2_1+l2_2+l2_3;
            dl2 = (dl2+dl2')/2;
            dl1 = 2*(l1_1+l1_2-2*l1_0a)/phi;
            dl2pinv = pinv2(dl2,tol2);
            dl2pinv = (dl2pinv+dl2pinv')/2;
            cv = dl2pinv*dl1;
            c(:,:,:,:,n) = reshape(cv,[bdl,bdl,d,d]);
            index = index+1;
            fom2(index) = abs(1+(-2*(cv'*l1_1+cv'*l1_2-2*cv'*l1_0a+cv.'*l1_3+cv.'*l1_4-2*cv.'*l1_0b)/phi+2*cv'*l2_1*cv+cv'*l2_2*cv+cv'*l2_3*cv)/(4*l0));
            if fom2(index) < 10^-10 || iter2 >= 20 || (iter2 >= 2 && std(fom2((iter2-2)*n+1:iter2*n),1)/mean(fom2((iter2-2)*n+1:iter2*n)) <= relunc2)
                break
            end
        end
    end
    fom2 = fom2(1:index);
    %plot(-log10(fom2))
    tensors = {b(:,:,:,:,n),c(:,:,:,:,n)};
    legs = {[-1,-3,1,2],[-2,-4,2,1]};
    f = ncon(tensors,legs);
    for x = n-1:-1:2
        tensors = {b(:,:,:,:,x),c(:,:,:,:,x),f};
        legs = {[-1,3,1,2],[-2,4,2,1],[3,4,-3,-4]};
        f = ncon(tensors,legs);
    end
    tensors = {b(:,:,:,:,1),c(:,:,:,:,1),f};
    legs = {[5,3,1,2],[6,4,2,1],[3,4,5,6]};
    f = ncon(tensors,legs);
    f = real(f);
end
result = f;
end